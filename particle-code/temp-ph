// This #include statement was automatically added by the Particle IDE.
#include <OneWire.h>


//Website for Surges-Sensor
//      : https://api.spark.io/v1/devices/3a0038000447353138383138/result?access_token=79f91e4993fc5439f7f9e0302d5ec1b75a9bd01c

// This #include statement was automatically added by the Particle IDE.
#include "OneWire/OneWire.h"

OneWire ds = OneWire(D4);       //D4 will be our 1-wire signal line    

char resultstr[256];
int led = D7;                   // The on-board LED    
unsigned long lastUpdate = 0;    
float Larry_Temp = -100;
//float Superfly = -100;
//float Erebus = -100;
//float Cronus = -100;
//float Monolith = -100;
//float Bender = -100;
    
void setup()
{
    pinMode(led, OUTPUT);     // Signal LED

    // expose your char buffer to the Cloud API
    Particle.variable("result", resultstr, STRING);
    Serial.begin(9600);       //Start Signal Communication
}

void loop()
{ 
    temperaturefunction();
}

void temperaturefunction()
{
    byte i;
    byte present = 0;
    byte type_s;
    byte data[12];
    byte addr[8];
    float celsius, fahrenheit;
    
    if ( !ds.search(addr)) {
        ds.reset_search();
        delay(250);
        return;
    }

///*    
    // Use to determine the addressess of the sensors connected to the Photon
    Serial.println();
    Serial.println("ROM =");
    for( i = 0; i < 8; i++){
        Serial.write(' ');
        Serial.print(addr[i]);
        Serial.println();
    }
//*/

    ds.reset();
    ds.select(addr);
    ds.write(0x44,0);
    delay(1000);
    
    present = ds.reset();
    ds.select(addr);
    ds.write(0xB8,0);
    ds.write(0x00,0);
    
    present = ds.reset();
    ds.select(addr);
    ds.write(0xBE,0);
    
    for ( i = 0; i < 9; i++){
        data[i] = ds.read();
    }

    int16_t raw = (data[1] << 8) | data[0];
    byte cfg = (data[4] & 0x60);    
    if (cfg == 0x00) raw = raw & ~7;  // 9 bit resolution, 93.75 ms
    if (cfg == 0x20) raw = raw & ~3; // 10 bit res, 187.5 ms
    if (cfg == 0x40) raw = raw & ~1; // 11 bit res, 375 ms
    // default is 12 bit resolution, 750 ms conversion time
    celsius = (float)raw * 0.0625;
    fahrenheit = celsius * 1.8 + 32;
  
    //if (addr[7] == 0x40) 
    Larry_Temp = celsius;
    //if (addr[7] == 0x61) Superfly = celsius;    
    //if (addr[7] == 0xA6) Erebus = celsius;
    //if (addr[7] == 0x23) Cronus = celsius;
    //if (addr[7] == 0x98) Monolith = celsius;
    //if (addr[7] == 0x5) Bender = celsius;


//    char *Gaia = "Biggles"; // read some data
//    float Superfly = celsius;

    //digitalWrite(led, HIGH); // signal light on
    // format your data as JSON, don't forget to escape the double quotes
    //sprintf(resultstr, "{\"Gaia\":%f,\"Superfly\":%f,\"Erebus\":%f}", Gaia, Superfly, Erebus);
    Serial.print(Larry_Temp);
    sprintf(resultstr, "{\"Larry_Temp\":%f}", Larry_Temp); 
    delay(1000); // wait for a second
    //digitalWrite(led, LOW);
    } // signal light off
