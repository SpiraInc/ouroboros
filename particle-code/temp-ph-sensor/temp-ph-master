/*
# Product: Analog pH Meter Kit / DF Robot
# SKU    : SEN0161
# Code revised by EJ Lear http://www.eaeroponics.com 
# NOTE: This code is for the DF Robot SEN0161 on the Photon, it updates to the console log every 10 Seconds as is, which 
# is great for calibration.  If you want to use this in production (aeroponics/hydroponics) I would reccomend testing with a minimum of 30 minutes between tests so you don't burn out the probe too quickly.
# CALIBRATION VIDEO: Mike Ratcliffe put together a great calibration video for both the SEN0161 and the larger, higher quality DFRobot Analog pH Meter Pro here: https://www.youtube.com/watch?v=BgHR5MutKHY
*/
#define SensorPin A0          //pH meter Analog output to Photon Analog Input A0
unsigned long int avgValue;  //Store the average value of the sensor feedback
float b;
int buf[10],temp;
void setup()
{  
}
void loop()
{
  for(int i=0;i<10;i++)       //Get 10 sample value from the sensor for smooth the value
  { 
    buf[i]=analogRead(SensorPin);
    delay(10);
  }
  for(int i=0;i<9;i++)        //sort the analog from small to large
  {
    for(int j=i+1;j<10;j++)
    {
      if(buf[i]>buf[j])
      {
        temp=buf[i];
        buf[i]=buf[j];
        buf[j]=temp;
      }
    }
  }
  avgValue=0;
  for(int i=2;i<8;i++)      //take the average value of 6 center sample
    avgValue+=buf[i];
  //float phValue=(float)avgValue*5.0/4095/6; // This code is for the Arduino only to use it, uncomment this line, and comment out the next one!
  float phValue=(float)avgValue*3.3/4095/6; // Works on Photon! (convert the analog into millivolt) You can tweak the middle (the 2890)number to get your measurements exact if you are calibrating with buffer solutions
  //ADDITIONAL NOTE: I used these settings and then adjusted the rheostat on the circuit board to get the calibration perfect.
  phValue=2.67*phValue;                      //convert the millivolt into pH value
  Particle.publish("phValue", String(phValue, 2));
  delay (10000); // Make sure you don't overload the console!  Keep above 2000 (2 seconds), also keep in mind that you have to let the probe sit for 2 minutes in the buffer solution anyway to get a correct reading.
}
/*
  Special thanks to:
  Rik Delmar who took a lot of sh!@ unnecessarily, my fault. :-( https://community.particle.io/u/ric/summary. 
  Nathan Robinson who got the publishing working! Thanks Nathan https://community.particle.io/u/nrobinson2000/summary
  Scruff for calling out on my crap :-) and helping with the 3.3v conversion! https://community.particle.io/u/scruffr/summary
*/    
// Much love :-)
